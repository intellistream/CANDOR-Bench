name: Build and Test

on:
  push:
    branches: [ main, main-dev, test ]
  pull_request:
    branches: [ main, main-dev, test ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  test-deployment:
    runs-on: ubuntu-22.04
    # test åˆ†æ”¯åšå¿«é€Ÿæµ‹è¯•ï¼Œmain å’Œ main-dev åšå®Œæ•´æµ‹è¯•
    # æ‰€æœ‰åˆ†æ”¯éƒ½è·³è¿‡ VSAGï¼ˆé€šè¿‡ CI ç¯å¢ƒå˜é‡è‡ªåŠ¨å¤„ç†ï¼‰
    env:
      FAST_BUILD: ${{ github.ref == 'refs/heads/test' && 'true' || 'false' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive  # åˆå§‹åŒ–æ‰€æœ‰ submodules
        
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Cache CMake build
      uses: actions/cache@v4
      with:
        path: |
          algorithms_impl/build
          algorithms_impl/faiss/build
          algorithms_impl/SPTAG/Release
          algorithms_impl/DiskANN/build
        key: ${{ runner.os }}-cmake-${{ hashFiles('algorithms_impl/CMakeLists.txt', 'algorithms_impl/**/*.cmake') }}
        restore-keys: |
          ${{ runner.os }}-cmake-
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          pkg-config \
          libgflags-dev \
          libboost-all-dev \
          libomp-dev \
          wget \
          curl
          
    - name: Clean old build artifacts
      run: |
        # åªæ¸…ç† .so æ–‡ä»¶ï¼Œä¿ç•™ build ç¼“å­˜
        rm -rf algorithms_impl/PyCANDYAlgo*.so
        
    - name: Run deployment script
      run: |
        chmod +x deploy.sh
        # è®¾ç½®å¹¶è¡Œç¼–è¯‘æ•°é‡
        export MAKEFLAGS="-j$(nproc)"
        export CMAKE_BUILD_PARALLEL_LEVEL=$(nproc)
        
        # CI ç¯å¢ƒå˜é‡å·²è®¾ç½®ï¼Œdeploy.sh ä¼šè‡ªåŠ¨è·³è¿‡ VSAG
        # test åˆ†æ”¯ï¼šå¿«é€Ÿæ„å»º
        # main/main-dev åˆ†æ”¯ï¼šå®Œæ•´æ„å»º
        if [ "${{ env.FAST_BUILD }}" = "true" ]; then
          echo "ğŸš€ å¿«é€Ÿæ„å»ºæ¨¡å¼ï¼ˆtest åˆ†æ”¯ï¼Œè·³è¿‡ VSAGï¼‰"
        else
          echo "ğŸ”¨ å®Œæ•´æ„å»ºæ¨¡å¼ï¼ˆmain/main-dev åˆ†æ”¯ï¼Œè·³è¿‡ VSAGï¼‰"
        fi
        ./deploy.sh
      timeout-minutes: 60
      env:
        # åŠ é€Ÿ pip å®‰è£…
        PIP_NO_CACHE_DIR: false
        PIP_DISABLE_PIP_VERSION_CHECK: 1
      
    - name: Verify Python packages
      run: |
        source sage-db-bench/bin/activate
        # ç¡®è®¤ä½¿ç”¨æ­£ç¡®çš„ Python
        which python3
        python3 --version
        
        # è®¾ç½®åº“è·¯å¾„
        TORCH_LIB=$(python3 -c "import torch; import os; print(os.path.join(os.path.dirname(torch.__file__), 'lib'))")
        export LD_LIBRARY_PATH="$TORCH_LIB:$LD_LIBRARY_PATH"
        
        # æ£€æŸ¥ .so æ–‡ä»¶å’Œç¬¦å·è¡¨
        echo "æ£€æŸ¥ PyCANDYAlgo.so æ–‡ä»¶..."
        SO_FILE=$(find algorithms_impl -name "PyCANDYAlgo*.so" -type f | head -1)
        if [ -n "$SO_FILE" ]; then
          echo "æ‰¾åˆ°: $SO_FILE"
          echo "æ–‡ä»¶å¤§å°: $(ls -lh "$SO_FILE" | awk '{print $5}')"
          echo ""
          echo "æ£€æŸ¥ PyInit ç¬¦å·..."
          nm -D "$SO_FILE" | grep PyInit || echo "âš  æœªæ‰¾åˆ° PyInit ç¬¦å·"
          echo ""
          echo "æ£€æŸ¥æ‰€æœ‰å¯¼å‡ºç¬¦å·..."
          nm -D "$SO_FILE" | grep " T " | head -20
        else
          echo "âŒ æœªæ‰¾åˆ° .so æ–‡ä»¶"
          exit 1
        fi
        
        # æµ‹è¯•å¯¼å…¥ PyCANDYAlgoï¼ˆæ‰€æœ‰åˆ†æ”¯ï¼‰
        cd algorithms_impl && python3 -c "import PyCANDYAlgo; print('âœ“ PyCANDYAlgo imported'); print(f'  Version: {PyCANDYAlgo.__version__}'); print(f'  Compiled: {PyCANDYAlgo.__compiled_time__}')" && cd ..
        
        # è·³è¿‡ pyvsag æµ‹è¯•ï¼ˆæ‰€æœ‰åˆ†æ”¯éƒ½ä¸æ„å»º VSAGï¼‰
        # python3 -c "import pyvsag; print('âœ“ pyvsag imported')"
        
        python3 -c "import numpy, torch, yaml; print('âœ“ Core dependencies OK')"
        
    - name: Run unit tests
      run: |
        source sage-db-bench/bin/activate
        
        # test åˆ†æ”¯ï¼šå¿«é€Ÿæµ‹è¯•ï¼ˆæ’é™¤æ€§èƒ½æµ‹è¯•ï¼‰
        if [ "${{ env.FAST_BUILD }}" = "true" ]; then
          echo "ğŸ§ª å¿«é€Ÿæµ‹è¯•æ¨¡å¼"
          pytest tests/ -v --tb=short --ignore=tests/test_performance.py -m "not slow" || true
        else
          echo "ğŸ§ª å®Œæ•´æµ‹è¯•æ¨¡å¼"
          pytest tests/ -v --tb=short || true
        fi
        
    - name: Check algorithm availability
      run: |
        source sage-db-bench/bin/activate
        python -c "
        from bench.algorithms import get_available_algorithms
        algos = get_available_algorithms()
        print(f'Available algorithms: {len(algos)}')
        for algo in algos:
            print(f'  - {algo}')
        " || echo "Algorithm check skipped"
        
    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          algorithms_impl/build.log
          algorithms_impl/build/CMakeFiles/*.log
        retention-days: 7

  lint-and-format:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install linting tools
      run: |
        pip install flake8 black isort mypy
        
    - name: Run flake8
      run: |
        flake8 bench/ datasets/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
        
    - name: Check code formatting
      run: |
        black --check bench/ datasets/ || true
        
    - name: Check import sorting
      run: |
        isort --check-only bench/ datasets/ || true
